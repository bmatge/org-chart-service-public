<!DOCTYPE html>
<html lang="fr" data-fr-scheme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OrganiChart — Organigrammes de l'administration publique</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.12.1/dist/dsfr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.12.1/dist/utility/utility.min.css">
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-org-chart@3/build/d3-org-chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-flextree@2.1.2/build/d3-flextree.js"></script>
<script src="https://chartsbuilder.matge.com/dist/gouv-widgets.umd.js"></script>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div id="tt"></div>

<header role="banner" class="fr-header">
  <div class="fr-header__body">
    <div class="fr-container">
      <div class="fr-header__body-row">
        <div class="fr-header__brand fr-enlarge-link">
          <div class="fr-header__brand-top">
            <div class="fr-header__logo">
              <p class="fr-logo">
                République<br>Française
              </p>
            </div>
          </div>
          <div class="fr-header__service">
            <a href="/" title="Accueil - gouv-orga">
              <p class="fr-header__service-title">OrganiChart</p>
            </a>
             
            <p class="fr-header__service-tagline"><span class="fr-badge fr-badge--warning fr-badge--sm fr-badge--no-icon">En developpement</span> Organigrammes de l'administration publique</p>
          </div>
        </div>  
      </div>
    </div>
  </div>
</header>

<div class="app-body">

<aside class="sidebar">
<div class="sidebar-inner">

  <!-- Source de donnees -->
  <div class="fr-select-group">
    <label class="fr-label" for="data-source">Source de donn&eacute;es</label>
    <select class="fr-select" id="data-source" onchange="toggleDataSource()">
      <option value="api-sp" selected>API Service Public</option>
      <option value="grist">GRIST</option>
    </select>
  </div>

  <!-- Config GRIST (cache par defaut) -->
  <fieldset class="fr-fieldset" id="grist-config" style="display:none">
    <div class="fr-fieldset__content">
      <div class="fr-select-group">
        <label class="fr-label" for="grist-server">Serveur GRIST</label>
        <select class="fr-select fr-select--sm" id="grist-server">
          <option value="https://grist.numerique.gouv.fr" selected>grist.numerique.gouv.fr</option>
          <option value="https://docs.getgrist.com">docs.getgrist.com</option>
          <option value="custom">Autre (auto-h&eacute;berg&eacute;)…</option>
        </select>
      </div>
      <div class="fr-input-group" id="grist-custom-url-group" style="display:none">
        <label class="fr-label" for="grist-custom-url">URL du serveur</label>
        <input class="fr-input" type="url" id="grist-custom-url" placeholder="https://grist.mondomaine.fr">
      </div>
      <div class="fr-input-group">
        <label class="fr-label" for="grist-key">Cl&eacute; API
          <span class="fr-hint-text">Param&egrave;tres du profil GRIST &rarr; API</span>
        </label>
        <input class="fr-input" type="password" id="grist-key">
      </div>
      <div class="fr-input-group">
        <label class="fr-label" for="grist-doc">ID du document
          <span class="fr-hint-text">Visible dans l'URL du document GRIST</span>
        </label>
        <input class="fr-input" type="text" id="grist-doc" placeholder="abc123…">
      </div>
      <button class="fr-btn fr-btn--secondary fr-btn--sm" type="button" onclick="loadGristTables()" id="grist-tables-btn" style="width:100%">Charger les tables</button>
      <div class="fr-select-group" id="grist-table-group" style="display:none">
        <label class="fr-label" for="grist-table">Table</label>
        <select class="fr-select fr-select--sm" id="grist-table">
          <option value="">— Chargez les tables d'abord —</option>
        </select>
      </div>
    </div>
  </fieldset>

  <!-- Recherche -->
  <fieldset class="fr-fieldset" id="sp-search" aria-labelledby="search-legend">
    <legend class="fr-fieldset__legend--regular fr-sr-only" id="search-legend">Entité racine</legend>
    <div class="fr-fieldset__content">
      <div class="fr-input-group">
        <label class="fr-label" for="search-input">
          Rechercher un organisme
          <span class="fr-hint-text">Ministère, direction, service…</span>
        </label>
        <div class="ac-wrap">
          <input class="fr-input" type="text" id="search-input" placeholder="Tapez pour rechercher…" autocomplete="off">
          <div class="ac-dropdown" id="ac-dropdown"></div>
        </div>
      </div>
      <div id="selected-wrap" style="display:none">
        <div class="selected-chip">
          <div>
            <div class="sc-name" id="sel-name"></div>
            <div class="sc-type" id="sel-type"></div>
          </div>
          <button class="sc-clear" onclick="clearSelection()" title="Effacer">&times;</button>
        </div>
      </div>
    </div>
  </fieldset>

  <!-- Catégories -->
  <details class="sidebar-disclosure" id="sp-categories">
    <summary>Catégories</summary>
    <fieldset class="fr-fieldset">
      <div class="fr-fieldset__content">
        <div class="fr-checkbox-group fr-checkbox-group--sm">
          <input type="checkbox" id="cat-SI" name="cat-SI" checked>
          <label class="fr-label" for="cat-SI">Service interministériel (SI)</label>
        </div>
        <div class="fr-checkbox-group fr-checkbox-group--sm">
          <input type="checkbox" id="cat-NA" name="cat-NA">
          <label class="fr-label" for="cat-NA">National (NA)</label>
        </div>
        <div class="fr-checkbox-group fr-checkbox-group--sm">
          <input type="checkbox" id="cat-RG" name="cat-RG">
          <label class="fr-label" for="cat-RG">Régional (RG)</label>
        </div>
        <div class="fr-checkbox-group fr-checkbox-group--sm">
          <input type="checkbox" id="cat-DP" name="cat-DP">
          <label class="fr-label" for="cat-DP">Départemental (DP)</label>
        </div>
        <div class="fr-checkbox-group fr-checkbox-group--sm">
          <input type="checkbox" id="cat-SL" name="cat-SL">
          <label class="fr-label" for="cat-SL">Service local (SL)</label>
        </div>
      </div>
    </fieldset>
  </details>

  <!-- Informations affichées -->
  <details class="sidebar-disclosure">
    <summary>Informations affichées</summary>
    <fieldset class="fr-fieldset">
      <div class="fr-fieldset__content">
        <div class="fr-checkbox-group fr-checkbox-group--sm">
          <input type="checkbox" id="show-resp" name="show-resp" checked>
          <label class="fr-label" for="show-resp">Responsable</label>
        </div>
        <div class="fr-checkbox-group fr-checkbox-group--sm">
          <input type="checkbox" id="show-tel" name="show-tel" checked>
          <label class="fr-label" for="show-tel">Téléphone</label>
        </div>
        <div class="fr-checkbox-group fr-checkbox-group--sm">
          <input type="checkbox" id="show-addr" name="show-addr">
          <label class="fr-label" for="show-addr">Adresse</label>
        </div>
        <div class="fr-checkbox-group fr-checkbox-group--sm">
          <input type="checkbox" id="show-contact" name="show-contact">
          <label class="fr-label" for="show-contact">Formulaire de contact</label>
        </div>
        <div class="fr-checkbox-group fr-checkbox-group--sm">
          <input type="checkbox" id="show-siren" name="show-siren">
          <label class="fr-label" for="show-siren">SIREN</label>
        </div>
        <div class="fr-checkbox-group fr-checkbox-group--sm">
          <input type="checkbox" id="show-social" name="show-social">
          <label class="fr-label" for="show-social">Réseaux sociaux</label>
        </div>
      </div>
    </fieldset>
  </details>

  <!-- Options -->
  <details class="sidebar-disclosure">
    <summary>Options</summary>
    <fieldset class="fr-fieldset">
      <div class="fr-fieldset__content">
        <div class="fr-input-group">
          <label class="fr-label" for="depth">Profondeur max</label>
          <div class="range-row">
            <input type="range" id="depth" min="1" max="5" value="3" oninput="document.getElementById('dv').textContent=this.value">
            <span class="range-val" id="dv">3</span>
          </div>
        </div>
        <div class="fr-input-group">
          <label class="fr-label" for="threshold">Seuil HTML / D3</label>
          <div class="range-row">
            <input type="range" id="threshold" min="1" max="200" step="1" value="5" oninput="document.getElementById('tv').textContent=this.value">
            <span class="range-val" id="tv">40</span>
          </div>
        </div>
        <div class="fr-select-group">
          <label class="fr-label" for="layout-mode">Disposition des enfants (D3)</label>
          <select class="fr-select fr-select--sm" id="layout-mode">
            <option value="compact" selected>Compact (2 colonnes)</option>
            <option value="spread">&Eacute;tal&eacute; (horizontal)</option>
            <option value="column">Colonne unique</option>
          </select>
        </div>
        <div class="fr-select-group">
          <label class="fr-label" for="layout-dir">Direction du graphe (D3)</label>
          <select class="fr-select fr-select--sm" id="layout-dir">
            <option value="top" selected>Haut &rarr; Bas</option>
            <option value="left">Gauche &rarr; Droite</option>
            <option value="bottom">Bas &rarr; Haut</option>
            <option value="right">Droite &rarr; Gauche</option>
          </select>
        </div>
        <div class="fr-select-group">
          <label class="fr-label" for="print-format">Format d'impression</label>
          <select class="fr-select fr-select--sm" id="print-format">
            <option value="A4-landscape" selected>A4 paysage</option>
            <option value="A4-portrait">A4 portrait</option>
            <option value="A3-landscape">A3 paysage</option>
            <option value="A3-portrait">A3 portrait</option>
          </select>
        </div>
      </div>
    </fieldset>
  </details>

  <button class="fr-btn" id="gen-btn" onclick="generate()" style="width:100%">
    Générer l'organigramme
  </button>

  <!-- Sauvegardes -->
  <details class="sidebar-disclosure" id="saves-disclosure">
    <summary>Sauvegardes <span class="saves-count" id="saves-count"></span></summary>
    <div class="saves-panel">
      <div class="saves-list" id="saves-list">
        <p class="saves-empty">Aucune sauvegarde</p>
      </div>
    </div>
  </details>

</div>
</aside>

<main class="main-zone">

  <div class="top-bar" id="top-bar" style="display:none">
    <p class="fr-badge fr-badge--sm fr-badge--no-icon fr-badge--info" id="sc-nodes">— noeuds</p>
    <p class="fr-badge fr-badge--sm fr-badge--no-icon fr-badge--info" id="sc-depth">— niveaux</p>
    <p class="fr-badge fr-badge--sm fr-badge--no-icon" id="sc-mode">—</p>
    <div class="d3-actions" id="d3-actions" style="display:none">
      <button class="fr-btn fr-btn--tertiary fr-btn--sm" onclick="d3c&&d3c.expandAll().render()">Déplier tout</button>
      <button class="fr-btn fr-btn--tertiary fr-btn--sm" onclick="d3c&&d3c.collapseAll().render()">Replier tout</button>
      <button class="fr-btn fr-btn--tertiary fr-btn--sm" onclick="d3c&&d3c.fit()">Centrer</button>
    </div>
  </div>

  <div class="node-actions" id="node-actions" style="display:none">
    <span class="fr-text--xs" style="color:var(--text-mention-grey)">Noeud :</span>
    <span class="fr-badge fr-badge--sm fr-badge--no-icon fr-badge--info" id="sel-node-label">—</span>
    <button class="fr-btn fr-btn--tertiary fr-btn--sm fr-btn--icon-left fr-icon-edit-line" onclick="editSelectedNode()">Editer</button>
    <button class="fr-btn fr-btn--tertiary fr-btn--sm fr-btn--icon-left fr-icon-add-line" onclick="addChildNode()">Ajouter enfant</button>
    <button class="fr-btn fr-btn--tertiary fr-btn--sm fr-btn--icon-left fr-icon-delete-line" onclick="deleteSelectedNode()">Supprimer</button>
    <button class="fr-btn fr-btn--tertiary fr-btn--sm" onclick="clearNodeSelection()">&times;</button>
  </div>

  <div class="chart-wrap" id="chart-wrap">
    <div class="empty-state" id="empty-state">
      <svg width="72" height="60" viewBox="0 0 72 60" fill="none">
        <circle cx="36" cy="10" r="9" fill="#e0e0e0"/>
        <circle cx="12" cy="50" r="8" fill="#e8e8e8"/>
        <circle cx="36" cy="50" r="8" fill="#e8e8e8"/>
        <circle cx="60" cy="50" r="8" fill="#e8e8e8"/>
        <line x1="36" y1="19" x2="12" y2="42" stroke="#e8e8e8" stroke-width="2.5"/>
        <line x1="36" y1="19" x2="36" y2="42" stroke="#e8e8e8" stroke-width="2.5"/>
        <line x1="36" y1="19" x2="60" y2="42" stroke="#e8e8e8" stroke-width="2.5"/>
      </svg>
      <p class="fr-text--lg">Recherchez un organisme et cliquez sur <strong>Générer</strong></p>
      <p class="fr-hint-text">L'organigramme est construit en suivant les liens hiérarchiques de l'API</p>
    </div>
  </div>

  <div class="bottom-bar" id="bottom-bar" style="display:none">
    <button class="fr-btn fr-btn--sm" onclick="saveToStorage()">Sauvegarder</button>
    <span class="bottom-sep"></span>
    <span class="fr-text--sm" style="color:var(--text-mention-grey)">Export :</span>
    <ul class="fr-btns-group fr-btns-group--sm fr-btns-group--inline">
      <li><button class="fr-btn fr-btn--secondary fr-btn--sm" onclick="doExport('json')">JSON</button></li>
      <li><button class="fr-btn fr-btn--secondary fr-btn--sm" onclick="doExport('html')">HTML</button></li>
      <li><button class="fr-btn fr-btn--secondary fr-btn--sm" onclick="doExport('png')">PNG (D3)</button></li>
      <li><button class="fr-btn fr-btn--secondary fr-btn--sm" onclick="doExport('svg')">SVG (D3)</button></li>
      <li><button class="fr-btn fr-btn--secondary fr-btn--sm" onclick="doExport('csv')">CSV</button></li>
      <li><button class="fr-btn fr-btn--secondary fr-btn--sm" onclick="doPrint()">Imprimer (PDF)</button></li>
    </ul>
  </div>

</main>
</div>

<!-- Modale edition / ajout de noeud -->
<div class="node-modal-overlay" id="node-modal" style="display:none" onclick="if(event.target===this)closeNodeModal()">
  <div class="node-modal">
    <div class="node-modal__header">
      <h3 class="node-modal__title" id="node-modal-title">Editer le noeud</h3>
      <button class="node-modal__close" onclick="closeNodeModal()" title="Fermer">&times;</button>
    </div>
    <div class="node-modal__body">
      <div class="fr-input-group">
        <label class="fr-label" for="nm-name">Nom <span class="fr-hint-text">Obligatoire</span></label>
        <input class="fr-input" type="text" id="nm-name" required>
      </div>
      <div class="fr-input-group">
        <label class="fr-label" for="nm-ancien">Ancien nom</label>
        <input class="fr-input" type="text" id="nm-ancien">
      </div>
      <div class="node-modal__row">
        <div class="fr-input-group">
          <label class="fr-label" for="nm-resp">Responsable</label>
          <input class="fr-input" type="text" id="nm-resp" placeholder="Prenom Nom">
        </div>
        <div class="fr-input-group">
          <label class="fr-label" for="nm-role">Fonction</label>
          <input class="fr-input" type="text" id="nm-role">
        </div>
      </div>
      <div class="fr-input-group">
        <label class="fr-label" for="nm-tel">Telephone</label>
        <input class="fr-input" type="text" id="nm-tel">
      </div>
      <div class="fr-input-group">
        <label class="fr-label" for="nm-addr">Adresse</label>
        <input class="fr-input" type="text" id="nm-addr">
      </div>
      <div class="fr-input-group">
        <label class="fr-label" for="nm-contact">Formulaire de contact <span class="fr-hint-text">URL</span></label>
        <input class="fr-input" type="url" id="nm-contact">
      </div>
      <div class="fr-input-group">
        <label class="fr-label" for="nm-siren">SIREN</label>
        <input class="fr-input" type="text" id="nm-siren">
      </div>
      <div class="fr-input-group">
        <label class="fr-label" for="nm-social">Reseaux sociaux <span class="fr-hint-text">Un par ligne : plateforme:url</span></label>
        <textarea class="fr-input" id="nm-social" rows="3" placeholder="Twitter:https://twitter.com/..."></textarea>
      </div>
    </div>
    <div class="node-modal__footer">
      <button class="fr-btn fr-btn--secondary" onclick="closeNodeModal()">Annuler</button>
      <button class="fr-btn" onclick="submitNodeModal()">Valider</button>
    </div>
  </div>
</div>

<!-- GRIST web components (invisibles) -->
<gouv-source id="grist-src" style="display:none"></gouv-source>
<gouv-normalize id="grist-norm" source="grist-src" trim style="display:none"></gouv-normalize>

<script src="lib.js"></script>
<script src="app.js"></script>
</body>
</html>
